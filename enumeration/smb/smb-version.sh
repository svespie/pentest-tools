#!/bin/bash
# modified from: https://book.hacktricks.xyz/pentesting/pentesting-smb
# attempts to fingerprint smb service when initiating a null session
# may need to be run more than once for a successful execution

default_rport=139
default_interface=eth0

if [ -z $1 ]
then
        printf "this script attempts to fingerprint an SMB service when initiating a null session\n\n" 
        printf "usage:\n\n"
        printf "\t$ sudo $0 <rhost> <optional: rport> <optional: interface>\n\n"
        exit
else 
        rhost=$1
fi
if [ ! -z $2 ];then rport=$2;else rport=$default_rport;fi
if [ ! -z $3 ];then interface=$3;else interface=$default_interface;fi
if [[ $EUID -ne 0 ]];then printf "this script must be run as root";exit;fi

tcpdump -s0 -n -i $interface src $rhost and port $rport -A -c 7 2>/dev/null | grep -i "samba\|s.a.m" | tr -d '.' | grep -oP 'UnixSamba.*[0-9a-z]' | tr -d '\n' & printf "smb version: " &
printf "exit" | smbclient -L $rhost 1>/dev/null 2>/dev/null
sleep 1.5
